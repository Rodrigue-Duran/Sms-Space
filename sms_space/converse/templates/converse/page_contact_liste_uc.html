{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mes Contacts</title>
    <link rel="stylesheet" href="{% static 'converse/page_contact_liste_uc.css' %}">
</head>
<body>
    <div class="menu-toggle" onclick="toggleSidebar()">☰</div>
    <div class="dark-mode-toggle" onclick="toggleDarkMode()">🌓</div>

    <nav class="sidebar" id="sidebar">
        <ul>
            <li><a href="{% url 'page_accueil_uc' user.id %}">🏠 Accueil</a></li>
            <li><a href="{% url 'page_mon_profil_uc' user.id %}">👤 Mon profil</a></li>
            <li><a href="{% url 'page_contact_liste_uc' user.id %}">📇 Contacts</a></li>
            <li><a href="{% url 'page_rechercher_uc_uc' user.id %}">🔍 Rechercher</a></li>
            <li><a href="{% url 'page_signaler_probleme_uc' user.id %}">⚠️ Signaler un problème</a></li>
            <li><a href="{% url 'page_demandes_recus_uc' user.id %}">📥 Demandes reçues</a></li>
            <li><a href="{% url 'page_demandes_envoyees_uc' user.id %}">📤 Demandes envoyées</a></li>
            <li><a href="{% url 'page_se_deconnecter_uc' user.id %}">🚪 Se déconnecter</a></li>
        </ul>
    </nav>

    <main class="main-content fade-in" id="mainContent">
        <h1 class="page-title">📇 Mes contacts</h1>

        <input type="text" id="searchInput" placeholder="🔍 Rechercher par pseudo..." onkeyup="filterContacts()">

        <div class="contact-list">
            {% if autres_utilisateurs %}
                {% for item in autres_utilisateurs %}
                    <div class="contact-card">
                        <div class="contact-info">
                            <h2>{{ item.autre.pseudo }}</h2>
                            <p>{{ item.autre.nom }} {{ item.autre.prenom }}</p>
                            {% if item.count > 0 %}
                                <span class="unread-count">
                                    📩 {{ item.count }} non lu{{ item.count|pluralize }}
                                </span>
                            {% endif %}
                        </div>

                        <div class="contact-actions">
                            {% if item.est_bloqueur %}
                                <form method="POST" action="{% url 'debloquer_contact' user.id item.autre.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="block-btn">✅ Débloquer</button>
                                </form>
                            {% elif item.est_bloque %}
                                <div class="blocked-message">🔒 Vous avez été bloqué par cet utilisateur.</div>
                            {% else %}
                                <a href="{% url 'page_contact_particulier_uc' user.id item.autre.id %}" class="chat-btn">💬 Discuter</a>
                                <form method="POST" action="{% url 'bloquer_contact' user.id item.autre.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="block-btn">🚫 Bloquer</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="no-contact">📭 Aucun contact trouvé pour le moment.</p>
            {% endif %}
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const mode = localStorage.getItem("theme");
            if (mode === "dark") {
                document.body.classList.add("dark-mode");
            }
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('mainContent').classList.toggle('shifted');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains("dark-mode");
            localStorage.setItem("theme", isDark ? "dark" : "light");
        }

        function filterContacts() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.contact-card');

            cards.forEach(card => {
                const pseudo = card.querySelector('h2').textContent.toLowerCase();
                card.style.display = pseudo.includes(input) ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>
